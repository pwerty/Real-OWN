name: Sync to Homelab

on:
  push:
    branches:
      - main
    paths:
      - 'tools/**'
      - 'infrastructure/**'
      - '.github/workflows/**'
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì¶”ê°€ (í…ŒìŠ¤íŠ¸ìš©)

jobs:
  sync:
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ Pull latest code to homelab
        run: |
          cd ~/Real-OWN
          echo "ğŸ”„ Fetching latest changes from GitHub..."
          
          # ë¡œì»¬ ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì²˜ë¦¬
          if ! git diff-index --quiet HEAD --; then
            echo "âš ï¸  Local changes detected. Stashing..."
            git stash
          fi
          
          git fetch origin main
          git pull origin main
          echo "âœ… Code synced successfully at $(date)"
          echo "ğŸ“¦ Updated files:"
          git log -1 --stat
      
      - name: ğŸš€ Trigger Jenkins Job
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
          JOB_NAME: "post-runner-after-pull"  # Jenkins Job ì´ë¦„ìœ¼ë¡œ ë³€ê²½ í•„ìš”
        run: |
          echo "ğŸ”” Triggering Jenkins Job: ${JOB_NAME}"
          
          CRUMB=$(curl -s -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
            "${JENKINS_URL}/crumbIssuer/api/json" | jq -r '.crumb')
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -u "${JENKINS_USER}:${JENKINS_TOKEN}" \
            -H "Jenkins-Crumb: ${CRUMB}" \
            "${JENKINS_URL}/job/${JOB_NAME}/build")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Jenkins Job triggered successfully"
          else
            echo "âš ï¸  Jenkins trigger returned HTTP $HTTP_CODE"
            echo "$RESPONSE"
          fi
