pipeline {
    agent any
    
    parameters {
        // ChatGPT ì§ˆë¬¸
        text(
            name: 'QUESTION',
            defaultValue: 'What is the difference between a coroutine and async/await in Unity?',
            description: 'ChatGPTì—ê²Œ ë¬¼ì–´ë³¼ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'
        )
        
        // ë¡œì»¬ ì €ì¥ì†Œ ê²½ë¡œ
        string(
            name: 'LOCAL_REPO_PATH',
            defaultValue: '/home/dabi/Real-OWN',
            description: 'í™ˆë©ì˜ Real-OWN ì €ì¥ì†Œ ì ˆëŒ€ê²½ë¡œ'
        )
        
        // GPT ëª¨ë¸ ì„ íƒ
        choice(
            name: 'GPT_MODEL',
            choices: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo'],
            description: 'ì‚¬ìš©í•  GPT ëª¨ë¸'
        )
    }
    
    environment {
        HOME = "${WORKSPACE}"
        // Kubernetes Secretì—ì„œ API í‚¤ ì½ê¸°
        CHATGPT_API_KEY = credentials('chatgpt-api-key')
    }
    
    options {
        skipDefaultCheckout()
        timeout(time: 5, unit: 'MINUTES')
    }

    stages {
        stage('Debug Environment') {
            steps {
                echo "================================================"
                echo "ğŸ” Environment Debug"
                echo "================================================"
                
                sh """#!/bin/bash
                    echo "Current User: \$(whoami)"
                    echo "Home Directory: \$HOME"
                    echo "Environment Type: Kubernetes Pod"
                    echo ""
                    if [ -n "\${CHATGPT_API_KEY}" ]; then
                        echo "âœ… API Key loaded from credentials"
                    else
                        echo "âŒ API Key not found"
                    fi
                """
            }
        }
        
        stage('Prepare') {
            steps {
                echo "================================================"
                echo "ğŸ¤– ChatGPT Query Job"
                echo "================================================"
                echo "Question: ${params.QUESTION}"
                echo "Model: ${params.GPT_MODEL}"
                echo "================================================"
                
                sh """#!/bin/bash
                    set -e
                    
                    # API í‚¤ ì¡´ì¬ í™•ì¸
                    if [ -z "\${CHATGPT_API_KEY}" ]; then
                        echo "âŒ ERROR: API key not found in credentials"
                        echo "Please create Jenkins credential with ID 'chatgpt-api-key'"
                        exit 1
                    fi
                    
                    # jq ìë™ ì„¤ì¹˜ (Pod í™˜ê²½)
                    if ! command -v jq &> /dev/null; then
                        echo "ğŸ“¦ Installing jq..."
                        apt-get update -qq && apt-get install -y -qq jq > /dev/null 2>&1
                        echo "âœ… jq installed successfully"
                    else
                        echo "âœ… jq already installed"
                    fi
                    
                    echo "âœ… Prerequisites check passed"
                """
            }
        }

        stage('Query ChatGPT') {
            steps {
                script {
                    def startTime = System.currentTimeMillis()
                    
                    sh """#!/bin/bash
                        set -e
                        
                        # ìƒ‰ìƒ ì •ì˜
                        GREEN='\\033[0;32m'
                        BLUE='\\033[0;34m'
                        YELLOW='\\033[1;33m'
                        RED='\\033[0;31m'
                        NC='\\033[0m'
                        
                        # API í‚¤ ì½ê¸°
                        API_KEY=\$(cat "${API_KEY_FILE}" | tr -d '[:space:]')
                         (í™˜ê²½ë³€ìˆ˜ì—ì„œ)
                        API_KEY="\${CHATGPT_API_KEY}"
                            echo -e "\${RED}âŒ ERROR: API key file is empty\${NC}"
                            exit 1
                        fi
                        
                        echo -e "\${BLUE}================================================\${NC}"
                        echo -e "\${GREEN}ğŸš€ Sending request to ChatGPT...\${NC}"
                        echo -e "\${BLUE}================================================\${NC}"
                        echo ""
                        
                        # API ìš”ì²­
                        RESPONSE=\$(curl -s https://api.openai.com/v1/chat/completions \\
                          -H "Content-Type: application/json" \\
                          -H "Authorization: Bearer \$API_KEY" \\
                          -d "{
                            \\"model\\": \\"${params.GPT_MODEL}\\",
                            \\"messages\\": [
                              {
                                \\"role\\": \\"user\\",
                                \\"content\\": \\"${params.QUESTION}\\"
                              }
                            ],
                            \\"temperature\\": 0.7
                          }")
                        
                        # ì—ëŸ¬ ì²´í¬
                        if echo "\$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
                            ERROR_MSG=\$(echo "\$RESPONSE" | jq -r '.error.message')
                            echo -e "\${RED}âŒ API Error: \$ERROR_MSG\${NC}"
                            exit 1
                        fi
                        
                        # ë‹µë³€ ì¶”ì¶œ ë° ì¶œë ¥
                        ANSWER=\$(echo "\$RESPONSE" | jq -r '.choices[0].message.content')
                        
                        if [ -z "\$ANSWER" ] || [ "\$ANSWER" = "null" ]; then
                            echo -e "\${RED}âŒ ERROR: Failed to get response from ChatGPT\${NC}"
                            echo -e "\${YELLOW}Raw Response:\${NC}"
                            echo "\$RESPONSE" | jq '.'
                            exit 1
                        fi
                        
                        echo -e "\${GREEN}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\${NC}"
                        echo -e "\${GREEN}â”‚  ğŸ“ ChatGPT Answer                                        â”‚\${NC}"
                        echo -e "\${GREEN}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\${NC}"
                        echo ""
                        echo "\$ANSWER"
                        echo ""
                        echo -e "\${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\${NC}"
                        
                        # í† í° ì‚¬ìš©ëŸ‰ ì¶œë ¥
                        PROMPT_TOKENS=\$(echo "\$RESPONSE" | jq -r '.usage.prompt_tokens')
                        COMPLETION_TOKENS=\$(echo "\$RESPONSE" | jq -r '.usage.completion_tokens')
                        TOTAL_TOKENS=\$(echo "\$RESPONSE" | jq -r '.usage.total_tokens')
                        
                        echo ""
                        echo -e "\${BLUE}ğŸ“Š Token Usage:\${NC}"
                        echo -e "   Prompt: \$PROMPT_TOKENS"
                        echo -e "   Completion: \$COMPLETION_TOKENS"
                        echo -e "   Total: \$TOTAL_TOKENS"
                    """
                    
                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    
                    echo ""
                    echo "================================================"
                    echo "âœ… Query completed successfully"
                    echo "â±ï¸  Response time: ${duration} seconds"
                    echo "================================================"
                }
            }
            
            post {
                success {
                    echo "âœ… ChatGPT query completed successfully"
                }
                failure {
                    echo "âŒ ChatGPT query failed. Check the logs above for details."
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ§¹ Cleaning up workspace"
            cleanWs()
        }
    }
}
