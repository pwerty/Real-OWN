pipeline {
    agent { 
        label 'unity-builder'
    }
    
    parameters {
        // ìŠ¤í¬ë¦½íŠ¸ ì„¤ì •
        string(
            name: 'SCRIPT_NAME',
            defaultValue: 'hello.sh',
            description: 'infrastructure/jenkins/tools/ ë‚´ì˜ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ëª… (ì˜ˆ: hello.sh, build.sh)'
        )
        
        // ìŠ¤í¬ë¦½íŠ¸ ì¸ì (ì„ íƒ)
        string(
            name: 'SCRIPT_ARGS',
            defaultValue: '',
            description: 'ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬í•  ì¸ì (ì„ íƒì‚¬í•­)'
        )
        
        // ë¡œì»¬ ì €ì¥ì†Œ ê²½ë¡œ
        string(
            name: 'LOCAL_REPO_PATH',
            defaultValue: '/home/dabi/Real-OWN',
            description: 'í™ˆë©ì˜ Real-OWN ì €ì¥ì†Œ ì ˆëŒ€ê²½ë¡œ'
        )
    }
    
    environment {
        HOME = "${WORKSPACE}"
    }
    
    options {
        skipDefaultCheckout()  // Git clone ìŠ¤í‚µ (ë¡œì»¬ ë³µì‚¬ ì‚¬ìš©)
    }

    stages {
        stage('Sync from Local Repository') {
            steps {
                echo "================================================"
                echo "ğŸ“¦ Syncing from local repository"
                echo "Source: ${params.LOCAL_REPO_PATH}/infrastructure/jenkins"
                echo "Target: ${WORKSPACE}"
                echo "================================================"
                
                sh """#!/bin/bash
                    set -e
                    
                    # ë¡œì»¬ ì €ì¥ì†Œ ì¡´ì¬ í™•ì¸
                    if [ ! -d "${params.LOCAL_REPO_PATH}" ]; then
                        echo "âŒ ERROR: Local repository not found at ${params.LOCAL_REPO_PATH}"
                        exit 1
                    fi
                    
                    # WORKSPACE ì •ë¦¬
                    rm -rf ${WORKSPACE}/*
                    
                    # ë¡œì»¬ì—ì„œ infrastructure/jenkins ì „ì²´ ë³µì‚¬ (ì´ˆê³ ì†)
                    cp -r ${params.LOCAL_REPO_PATH}/infrastructure/jenkins/* ${WORKSPACE}/
                    
                    echo "âœ… Files synced successfully"
                    echo ""
                    echo "ğŸ“‚ Workspace contents:"
                    ls -lh ${WORKSPACE}
                """
            }
        }

        stage('Execute Script') {
            steps {
                script {
                    def startTime = System.currentTimeMillis()

                    echo "================================================"
                    echo "ğŸ”¨ Executing Custom Script"
                    echo "Script: tools/${params.SCRIPT_NAME}"
                    if (params.SCRIPT_ARGS) {
                        echo "Arguments: ${params.SCRIPT_ARGS}"
                    }
                    echo "================================================"
                    
                    sh """#!/bin/bash
                        set -e
                        
                        SCRIPT_PATH="tools/${params.SCRIPT_NAME}"
                        
                        # ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                        if [ ! -f "\${SCRIPT_PATH}" ]; then
                            echo "âŒ ERROR: Script not found at \${SCRIPT_PATH}"
                            exit 1
                        fi
                        
                        # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
                        chmod +x "\${SCRIPT_PATH}"
                        
                        # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                        echo "ğŸš€ Running \${SCRIPT_PATH}..."
                        if [ -n "${params.SCRIPT_ARGS}" ]; then
                            "\${SCRIPT_PATH}" ${params.SCRIPT_ARGS}
                        else
                            "\${SCRIPT_PATH}"
                        fi
                    """

                    def endTime = System.currentTimeMillis()
                    def duration = (endTime - startTime) / 1000
                    
                    echo "================================================"
                    echo "âœ… SCRIPT COMPLETED"
                    echo "â±ï¸  Total Duration: ${duration} seconds"
                    echo "================================================"
                }
            }
            
            post {
                success {
                    echo "âœ… Script executed successfully"
                }
                failure {
                    echo "âŒ Script execution failed. Check the logs above for details."
                }
            }
        }
    }
    
    post {
        always {
            echo "================================================"
            echo "ğŸ§¹ Cleaning up workspace"
            echo "================================================"
            cleanWs()
        }
    }
}
